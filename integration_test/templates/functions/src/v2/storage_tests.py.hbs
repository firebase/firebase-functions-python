"""
Storage trigger tests for v2
Test Run ID: {{testRunId}}
"""

from firebase_admin import firestore
from firebase_functions import storage_fn

REGION = "{{region}}"

{{#each functions}}
@storage_fn.{{decorator}}(
    bucket="{{bucket}}",
    region=REGION,
    timeout_sec={{timeout}}
)
def {{name}}{{../testRunId}}(event: storage_fn.CloudEvent[storage_fn.StorageObjectData]) -> None:
    """
    Test function: {{name}}
    Trigger: {{trigger}}
    Bucket: {{bucket}}
    """
    # Extract test_id from filename (assumes format: testId.txt)
    filename = event.data.name
    test_id = filename.replace('.txt', '') if filename.endswith('.txt') else filename

    # Prepare context data for storage
    context_data = {
        "id": event.id,
        "time": event.time,
        "type": f"google.cloud.storage.object.v1.{{eventType}}",
        "source": event.source,
    }

    # Store context in Firestore for verification
    db = firestore.client()
    collection_name = "{{#if collection}}{{collection}}{{else}}{{name}}{{/if}}"
    db.collection(collection_name).document(test_id).set(context_data)

{{/each}}
